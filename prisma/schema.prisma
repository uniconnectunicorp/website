// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id
  name          String?
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  role          Role      @default(seller)
  active        Boolean   @default(true)
  permissions   Json?     @default("{}")
  finance       Finance[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  sessions      Session[]
  accounts      Account[]
  sellerConfig  SellerConfig?
  leadsAssigned Lead[]    @relation("LeadAssignedTo")
  enrollmentLinksGenerated EnrollmentLink[] @relation("EnrollmentLinkSeller")

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}


model Lead {
  id              String   @id
  name            String
  email           String?
  phone           String
  message         String?
  cpf             String?
  rg              String?
  birthDate       String?
  address         String?
  houseNumber     String?
  neighborhood    String?
  city            String?
  state           String?
  zipCode         String?
  civilStatus     String?
  course          String?
  courseValue      Float?
  modalidade      Modalidade?
  status          LeadStatus @default(pending)
  notes           String?
  assignedTo      String?
  assignedUser    User?      @relation("LeadAssignedTo", fields: [assignedTo], references: [id])
  source          String?
  sessionId       String?
  campaign        String?
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  history         LeadHistory[]
  tarefas         Tarefa[]
  paymentMethodId String?
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  installments    Int?
  finance         Finance?
  matricula       Matricula?
  enrollmentLink  EnrollmentLink?
  lossReason      String?
  stagesBeforeLoss String?
  convertedAt     DateTime?
  lostAt          DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([assignedTo])
  @@index([sessionId])
  @@index([phone])
  @@index([status])
  @@map("lead")
}

model LeadHistory {
  id         String   @id
  leadId     String
  lead       Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  action     String
  fromStatus String?
  toStatus   String?
  userId     String?
  createdAt  DateTime @default(now())

  @@index([leadId])
  @@map("lead_history")
}

model EnrollmentLink {
  id          String   @id
  token       String   @unique
  leadId      String   @unique
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  sellerId    String
  seller      User     @relation("EnrollmentLinkSeller", fields: [sellerId], references: [id])
  used        Boolean  @default(false)
  usedAt      DateTime?
  expiresAt   DateTime?
  createdAt   DateTime @default(now())

  @@index([token])
  @@map("enrollment_link")
}

model Matricula {
  id                 String          @id
  leadId             String          @unique
  lead               Lead            @relation(fields: [leadId], references: [id], onDelete: Cascade)
  numero             String          @unique
  status             MatriculaStatus @default(ativa)
  modalidade         Modalidade      @default(regular)
  dataInicio         DateTime        @default(now())
  dataConclusao      DateTime?
  dataCancelamento   DateTime?
  motivoCancelamento String?
  certificadoEmitido Boolean         @default(false)
  dataCertificado    DateTime?
  notaEmitida        Boolean         @default(false)
  dataNotaEmitida    DateTime?
  observacoes        String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  @@map("matricula")
}

model Tarefa {
  id          String       @id
  leadId      String
  lead        Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  titulo      String
  descricao   String?
  tipo        TarefaTipo   @default(followup)
  status      TarefaStatus @default(pendente)
  prazo       DateTime?
  concluidaEm DateTime?
  assignedTo  String
  criadoPor   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([leadId])
  @@index([assignedTo])
  @@map("tarefa")
}

model SellerConfig {
  id          String @id
  userId      String @unique
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  minValue    Float  @default(0)
  maxValue    Float  @default(99999)
  valueLimits Json?  @default("{}")

  @@map("seller_config")
}

model PaymentMethod {
  id                    String  @id
  name                  String
  type                  PaymentType
  maxInstallments       Int?
  active                Boolean @default(true)
  visibleOnEnrollment   Boolean @default(true)
  feePercentage         Float   @default(0)
  commissionPercentage  Float   @default(0)
  commissionType        String  @default("percentage")
  leads                 Lead[]
  finances              Finance[]
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("payment_method")
}

model Finance {
  id              String        @id
  leadId          String?       @unique
  lead            Lead?         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  amount          Float
  netAmount       Float?
  feeAmount       Float?
  commissionAmount Float?
  installments    Int?
  type            FinanceType
  category        String?
  description     String?
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentMethodId String?
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  transactionDate DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([type])
  @@index([transactionDate])
  @@index([userId])
  @@map("finance")
}

model Notificacao {
  id        String          @id
  userId    String
  titulo    String
  mensagem  String
  tipo      NotificacaoTipo @default(info)
  lida      Boolean         @default(false)
  lidaAt    DateTime?
  linkUrl   String?
  createdAt DateTime        @default(now())

  @@index([userId])
  @@index([lida])
  @@map("notificacao")
}

enum Role {
  director
  finance
  seller
  manager
  admin
}

enum PaymentType {
  pix
  credit
  debit
}

enum LeadStatus {
  pending
  contacted
  negociating
  confirmPayment
  enrolled
  converted
  lost
}

enum MatriculaStatus {
  ativa
  concluida
  cancelada
  trancada
}

enum Modalidade {
  regular
  aproveitamento
  competencia
}

enum TarefaTipo {
  followup
  ligacao
  reuniao
  email
  visita
  outro
}

enum TarefaStatus {
  pendente
  emAndamento
  concluida
  cancelada
}

enum NotificacaoTipo {
  info
  sucesso
  alerta
  erro
}

enum FinanceType {
  in
  out
  other
  leadPayment
}